<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>投票ページ</title>
  <link rel="stylesheet" href="style.css?v=1" />
  <style>
    .photo-card {
      display: inline-block;
      margin: 1rem;
      border: 3px solid transparent;
      border-radius: 10px;
      transition: border-color 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    .photo-card img {
      display: block;
      width: 200px;
      height: auto;
      border-radius: 10px;
    }
    .photo-card.selected {
      border-color: #42a5f5;
      box-shadow: 0 0 10px rgba(66, 165, 245, 0.5);
    }
    .photo-label {
      text-align: center;
      margin-top: 0.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">📸 気に入った写真を1枚クリックで選択してね ✨</h2>

  <form id="voteForm">
    <div id="photo-container" style="text-align:center;"></div>
    <div style="text-align:center; margin-top:1rem;">
      <button id="vote-button" type="submit">投票する</button>
      <button id="reload-button" type="button">🔄</button>
    </div>
  </form>

  <script>
    let selectedId = null;

    fetch('/photo-meta')
      .then(res => res.ok ? res.json() : Promise.reject('取得失敗'))
      .then(photos => {
        const container = document.getElementById('photo-container');
        const shuffled = photos.sort(() => 0.5 - Math.random()).slice(0, 6);

        shuffled.forEach(photo => {
          const div = document.createElement('div');
          div.className = 'photo-card';
          div.dataset.id = photo.filename;

          div.innerHTML = `
            <img src="/image/${photo.filename}" alt="写真">
            <div class="photo-label">${photo.author}さんの写真</div>
          `;

          div.addEventListener('click', () => {
            document.querySelectorAll('.photo-card').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
            selectedId = photo.filename;
          });

          container.appendChild(div);
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('photo-container').innerHTML = '<p style="color:red;">画像の取得に失敗しました。</p>';
      });

    document.getElementById('voteForm').addEventListener('submit', e => {
      e.preventDefault();
      if (!selectedId) return alert('写真を選択してください');

      fetch('/vote-photo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ photoId: selectedId })
      })
      .then(() => fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageUrl: selectedId, characterId: selectedId })
      }))
      .then(() => {
        alert("投票ありがとうございました！");
        location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("投票エラーが発生しました。");
      });
    });

    document.getElementById("reload-button").addEventListener("click", () => location.reload());
  </script>

  <!-- admax -->
  <script src="https://adm.shinobi.jp/s/932c9bf67e636e25d45fea85af67e7cd"></script>
  <!-- admax -->

</body>
</html>
